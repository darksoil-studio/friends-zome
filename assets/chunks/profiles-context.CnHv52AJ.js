import{_ as U}from"./tslib.es6.kHcLnhpD.js";import{e as N,a as W}from"./context.Bkj8EDfc.js";import{a as O,n as T,c as L,t as D}from"./property.CPxPeo4V.js";import{c as M,g as Z,h as E,j as R,k as q,l as V,s as b,m as G,H as k,n as $,S as p,e as l,o as K,p as _,q as v,d as X,A as P,Z as Y,M as x,x as J,r as Q,i as j}from"./friends-client.BHFcpvB2.js";import{S as ee}from"./signal-watcher.D20SjYbO.js";import"./commonjsHelpers.BosuxZz1.js";var te=100,ie=2048,se=function(){function s(e,t,i,r,n,o,h,a){e===void 0&&(e=M.defaultCodec),t===void 0&&(t=void 0),i===void 0&&(i=te),r===void 0&&(r=ie),n===void 0&&(n=!1),o===void 0&&(o=!1),h===void 0&&(h=!1),a===void 0&&(a=!1),this.extensionCodec=e,this.context=t,this.maxDepth=i,this.initialBufferSize=r,this.sortKeys=n,this.forceFloat32=o,this.ignoreUndefined=h,this.forceIntegerToFloat=a,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}return s.prototype.reinitializeState=function(){this.pos=0},s.prototype.encodeSharedRef=function(e){return this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)},s.prototype.encode=function(e){return this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)},s.prototype.doEncode=function(e,t){if(t>this.maxDepth)throw new Error("Too deep objects in depth ".concat(t));e==null?this.encodeNil():typeof e=="boolean"?this.encodeBoolean(e):typeof e=="number"?this.encodeNumber(e):typeof e=="string"?this.encodeString(e):this.encodeObject(e,t)},s.prototype.ensureBufferSizeToWrite=function(e){var t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(t*2)},s.prototype.resizeBuffer=function(e){var t=new ArrayBuffer(e),i=new Uint8Array(t),r=new DataView(t);i.set(this.bytes),this.view=r,this.bytes=i},s.prototype.encodeNil=function(){this.writeU8(192)},s.prototype.encodeBoolean=function(e){e===!1?this.writeU8(194):this.writeU8(195)},s.prototype.encodeNumber=function(e){Number.isSafeInteger(e)&&!this.forceIntegerToFloat?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):(this.writeU8(211),this.writeI64(e)):this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))},s.prototype.writeStringHeader=function(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else if(e<4294967296)this.writeU8(219),this.writeU32(e);else throw new Error("Too long string: ".concat(e," bytes in UTF-8"))},s.prototype.encodeString=function(e){var t=5,i=e.length;if(i>Z){var r=E(e);this.ensureBufferSizeToWrite(t+r),this.writeStringHeader(r),R(e,this.bytes,this.pos),this.pos+=r}else{var r=E(e);this.ensureBufferSizeToWrite(t+r),this.writeStringHeader(r),q(e,this.bytes,this.pos),this.pos+=r}},s.prototype.encodeObject=function(e,t){var i=this.extensionCodec.tryToEncode(e,this.context);if(i!=null)this.encodeExtension(i);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else if(typeof e=="object")this.encodeMap(e,t);else throw new Error("Unrecognized object: ".concat(Object.prototype.toString.apply(e)))},s.prototype.encodeBinary=function(e){var t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else if(t<4294967296)this.writeU8(198),this.writeU32(t);else throw new Error("Too large binary: ".concat(t));var i=V(e);this.writeU8a(i)},s.prototype.encodeArray=function(e,t){var i=e.length;if(i<16)this.writeU8(144+i);else if(i<65536)this.writeU8(220),this.writeU16(i);else if(i<4294967296)this.writeU8(221),this.writeU32(i);else throw new Error("Too large array: ".concat(i));for(var r=0,n=e;r<n.length;r++){var o=n[r];this.doEncode(o,t+1)}},s.prototype.countWithoutUndefined=function(e,t){for(var i=0,r=0,n=t;r<n.length;r++){var o=n[r];e[o]!==void 0&&i++}return i},s.prototype.encodeMap=function(e,t){var i=Object.keys(e);this.sortKeys&&i.sort();var r=this.ignoreUndefined?this.countWithoutUndefined(e,i):i.length;if(r<16)this.writeU8(128+r);else if(r<65536)this.writeU8(222),this.writeU16(r);else if(r<4294967296)this.writeU8(223),this.writeU32(r);else throw new Error("Too large map object: ".concat(r));for(var n=0,o=i;n<o.length;n++){var h=o[n],a=e[h];this.ignoreUndefined&&a===void 0||(this.encodeString(h),this.doEncode(a,t+1))}},s.prototype.encodeExtension=function(e){var t=e.data.length;if(t===1)this.writeU8(212);else if(t===2)this.writeU8(213);else if(t===4)this.writeU8(214);else if(t===8)this.writeU8(215);else if(t===16)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else if(t<4294967296)this.writeU8(201),this.writeU32(t);else throw new Error("Too large extension object: ".concat(t));this.writeI8(e.type),this.writeU8a(e.data)},s.prototype.writeU8=function(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++},s.prototype.writeU8a=function(e){var t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t},s.prototype.writeI8=function(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++},s.prototype.writeU16=function(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2},s.prototype.writeI16=function(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2},s.prototype.writeU32=function(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4},s.prototype.writeI32=function(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4},s.prototype.writeF32=function(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4},s.prototype.writeF64=function(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8},s.prototype.writeU64=function(e){this.ensureBufferSizeToWrite(8),b(this.view,this.pos,e),this.pos+=8},s.prototype.writeI64=function(e){this.ensureBufferSizeToWrite(8),G(this.view,this.pos,e),this.pos+=8},s}(),re={};function ne(s,e){e===void 0&&(e=re);var t=new se(e.extensionCodec,e.context,e.maxDepth,e.initialBufferSize,e.sortKeys,e.forceFloat32,e.ignoreUndefined,e.forceIntegerToFloat);return t.encodeSharedRef(s)}function oe(s,e){const t=new k;for(const i of e)t.set(i,s.get(i));return t}function ae(s){return Math.floor(s/1e3)}function he(s){var t,i;const e=(i=(t=s.entry)==null?void 0:t.Present)==null?void 0:i.entry;return $(e)}class m{constructor(e){this.record=e}get actionHash(){return this.record.signed_action.hashed.hash}get action(){const e=this.record.signed_action.hashed.content;return{...e,timestamp:ae(e.timestamp)}}get entry(){return he(this.record)}get entryHash(){return this.record.signed_action.hashed.content.entry_hash}}const S=2e4;function B(s){return{base:s.hashed.content.base_address,author:s.hashed.content.author,link_type:s.hashed.content.link_type,tag:s.hashed.content.tag,target:s.hashed.content.target_address,timestamp:s.hashed.content.timestamp,zome_index:s.hashed.content.zome_index,create_link_hash:s.hashed.hash}}function le(s,e,t,i=S){let r=!1,n;const o=new p.State({status:"pending"},{[p.subtle.watched]:()=>{r=!0;let h;const a=w=>{if(!r)return;const u=H(w||[]).sort(C);(!h||!I(u.map(f=>f.create_link_hash),h.map(f=>f.create_link_hash)))&&(h=u,o.set({status:"completed",value:h}))},c=()=>{r&&e().then(a).catch(w=>o.set({status:"error",error:w})).finally(()=>{r&&setTimeout(()=>c(),i)})};c(),n=s.onSignal(w=>{if(!w.type)return;const u=w;u.type==="LinkCreated"?t===u.link_type&&a([...h||[],B(u.action)]):u.type==="LinkDeleted"&&t===u.link_type&&a((h||[]).filter(f=>l(f.create_link_hash)!==l(u.create_link_action.hashed.hash)))})},[p.subtle.unwatched]:()=>{o.set({status:"pending"}),r=!1,n()}});return o}class F extends Error{constructor(){super("NOT_FOUND")}}function fe(s,e=1e3,t=4){let i=!1;const r=new p.State({status:"pending"},{[p.subtle.watched]:()=>{if(i)return;let n=0;const o=()=>{n+=1,s().then(h=>{h?(i=!0,r.set({status:"completed",value:h})):n<t?setTimeout(()=>o(),e):r.set({status:"error",error:new F})}).catch(h=>{n<t?setTimeout(()=>o(),e):r.set({status:"error",error:h})})};o()},[p.subtle.unwatched]:()=>{i||r.set({status:"pending"})}});return r}function ce(s,e,t=S){let i=!1,r,n;const o=new p.State({status:"pending"},{[p.subtle.watched]:()=>{i=!0;const h=async()=>{if(i)try{const a=await e();a?(!n||l(n.actionHash)!==l(a.actionHash))&&(n=a,o.set({status:"completed",value:n})):o.set({status:"error",error:new F})}catch(a){o.set({status:"error",error:a})}finally{i&&setTimeout(()=>h(),t)}};h(),r=s.onSignal(a=>{if(!i||!a.type)return;const c=a;c.type==="EntryUpdated"&&n&&l(n.actionHash)===l(c.action.hashed.content.original_action_address)&&(n=new m({entry:{Present:{entry_type:"App",entry:ne(c.app_entry)}},signed_action:c.action}),o.set({status:"completed",value:n}))})},[p.subtle.unwatched]:()=>{o.set({status:"pending"}),i=!1,n=void 0,r()}});return o}const C=(s,e)=>s.timestamp-e.timestamp;function ue(s){const e=s.map(i=>l(i));return[...new Set(e)].map(i=>X(i))}function H(s){const e=new k;for(const t of s)e.set(t.create_link_hash,t);return Array.from(e.values())}function I(s,e){if(s.length!==e.length)return!1;for(let t=0;t<s.length;t+=1)if(l(s[t])!==l(e[t]))return!1;return!0}function A(s,e,t,i,r=S){let n=e;K(n)===_.AGENT&&(n=v(n,_.ENTRY));let o=!1,h,a;const c=new p.State({status:"pending"},{[p.subtle.watched]:()=>{o=!0;const w=f=>{if(!o)return;const d=H(f||[]).sort(C);(!a||!I(d.map(g=>g.create_link_hash),a.map(g=>g.create_link_hash)))&&(a=d,c.set({status:"completed",value:a}))},u=async()=>{o&&t().then(w).finally(()=>{o&&setTimeout(()=>u(),r)})};u().catch(f=>{c.set({status:"error",error:f})}),h=s.onSignal(f=>{if(!f.type)return;const d=f;d.type==="LinkCreated"?i===d.link_type&&(l(d.action.hashed.content.base_address)===l(n)||l(v(d.action.hashed.content.base_address,_.AGENT))===l(n))&&w([...a||[],B(d.action)]):d.type==="LinkDeleted"&&i===d.link_type&&l(d.create_link_action.hashed.content.base_address)===l(n)&&w((a||[]).filter(g=>l(g.create_link_hash)!==l(d.create_link_action.hashed.hash)))})},[p.subtle.unwatched]:()=>{c.set({status:"pending"}),o=!1,a=void 0,h()}});return c}function z(s,e){return new P(()=>{const t=s.get();return t.status!=="completed"?t:{status:"completed",value:e(t.value)}})}const de=O("hc_zome_profiles/store");class pe extends Y{constructor(e,t,i="profiles"){super(e,t,i),this.client=e,this.roleName=t,this.zomeName=i}async getProfileForAgent(e){return this.callZome("get_profile_for_agent",e)}async getAgentsForProfile(e){return this.callZome("get_agents_for_profile",e)}async getLatestProfile(e){const t=await this.callZome("get_latest_profile",e);return t?new m(t):void 0}async getOriginalProfile(e){const t=await this.callZome("get_original_profile",e);return t?new m(t):void 0}async searchProfiles(e){return this.callZome("search_profiles",e)}async getAllProfiles(){return this.callZome("get_all_profiles",null)}async createProfile(e){const t=await this.callZome("create_profile",e);return new m(t)}async updateProfile(e,t){const i=await this.callZome("update_profile",{previous_profile_hash:e,updated_profile:t});return new m(i)}async linkMyAgentToProfile(e){await this.callZome("link_my_agent_to_profile",e)}}const we={avatarMode:"avatar-optional",additionalFields:[],minNicknameLength:3};class ye{constructor(e,t={}){this.client=e,this.allProfiles=z(le(this.client,()=>this.client.getAllProfiles(),"PathToProfile"),i=>{const r=i.map(n=>n.target);return oe(this.profiles,r)}),this.agentToProfileLinks=new x(i=>A(this.client,i,()=>this.client.getProfileForAgent(i),"AgentToProfile")),this.profileForAgent=new x(i=>new P(()=>{const r=this.agentToProfileLinks.get(i).get();if(r.status!=="completed")return r;if(r.value.length===0)return{status:"completed",value:void 0};const o=r.value.sort((h,a)=>a.timestamp-h.timestamp)[0].target;return{status:"completed",value:this.profiles.get(o)}})),this.agentsForProfile=new x(i=>z(A(this.client,i,()=>this.client.getAgentsForProfile(i),"ProfileToAgent"),r=>ue(r.map(n=>v(n.target,_.AGENT))))),this.profiles=new x(i=>({profileHash:i,latestVersion:ce(this.client,()=>this.client.getLatestProfile(i)),original:fe(()=>this.client.getOriginalProfile(i))})),this.myProfile=this.profileForAgent.get(this.client.client.myPubKey),this.config={...we,...t}}}let y=class extends ee(Q){constructor(){super(...arguments),this.zome="profiles"}connectedCallback(){if(super.connectedCallback(),!this.store){if(!this.role)throw new Error('<profiles-context> must have a role="YOUR_DNA_ROLE" property, eg: <profiles-context role="role1">');if(!this.client)throw new Error(`<profiles-context> must either:
				a) be placed inside <app-client-context>
					or 
				b) receive an AppClient property (eg. <profiles-context .client=\${client}>) 
					or 
				c) receive a store property (eg. <profiles-context .store=\${store}>)`);this.store=new ye(new pe(this.client,this.role,this.zome))}}render(){return J`<slot></slot>`}};y.styles=j`
		:host {
			display: contents;
		}
	`;U([N({context:de}),T({type:Object})],y.prototype,"store",void 0);U([L({context:W,subscribe:!0})],y.prototype,"client",void 0);U([T()],y.prototype,"role",void 0);U([T()],y.prototype,"zome",void 0);y=U([D("profiles-context")],y);export{y as ProfilesContext};
